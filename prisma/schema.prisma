// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  name      String
  role      String   // admin, judge
  password  String   // hashed
  avatarUrl String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  assignments Assignment[]
  projects    Project[]
}

model Hackathon {
  id            String   @id @default(uuid())
  title         String
  tagline       String
  city          String?
  startAt       DateTime
  endAt         DateTime
  status        String   // draft, upcoming, active, judging, completed
  coverGradient String
  submissionSchema Json?  // Stores the form configuration
  leaderboardData Json?   // Admin-curated ranking: [{ projectId, rank, award }]
  leaderboardPublished Boolean @default(false)
  rulesUrl      String?
  detailsUrl    String?
  gitbookUrl    String?
  prizePool     String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  sessions         Session[]
  projects         Project[]
  scoringCriteria  ScoringCriterion[]
}

model ScoringCriterion {
  id          String   @id @default(uuid())
  hackathonId String
  hackathon   Hackathon @relation(fields: [hackathonId], references: [id], onDelete: Cascade)
  name        String
  maxScore    Int
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([hackathonId])
}

model Session {
  id          String   @id @default(uuid())
  hackathonId String
  hackathon   Hackathon @relation(fields: [hackathonId], references: [id])
  name        String
  type        String   // preliminary, semi_final, final
  status      String   // draft, active, judging, completed
  startAt     DateTime
  endAt       DateTime
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  projects    Project[]
  assignments Assignment[]
}

model Project {
  id          String   @id @default(uuid())
  hackathonId String
  hackathon   Hackathon @relation(fields: [hackathonId], references: [id])
  sessionId   String?
  session     Session?  @relation(fields: [sessionId], references: [id])
  userId      String?
  user        User?     @relation(fields: [userId], references: [id])

  submitterEmail String
  submitterName  String?

  title       String
  oneLiner    String
  description String?   // Detailed description (markdown)
  tags        String[]
  demoUrl     String?
  repoUrl     String?
  submissionData Json?  // Stores the actual form submission data
  status      String?  // draft, submitted

  votes       Int      @default(0)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  assignments Assignment[]
}

model Assignment {
  id        String   @id @default(uuid())
  sessionId String
  session   Session  @relation(fields: [sessionId], references: [id])
  projectId String
  project   Project  @relation(fields: [projectId], references: [id])
  judgeId   String
  judge     User     @relation(fields: [judgeId], references: [id])

  status     String   // pending, in_progress, completed
  comment    String?
  totalScore Float?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  scores Score[]

  @@unique([sessionId, projectId, judgeId])
}

model Score {
  id          String   @id @default(uuid())
  assignmentId String
  assignment  Assignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  criterionId String
  score       Int
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([assignmentId])
  @@index([criterionId])
}
